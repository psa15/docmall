<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.docmall.mapper.OrderMapper">

	<!-- 주문 폼 중 상품 목록 -->
	<select id="cartOrderList" resultType="com.docmall.domain.CartOrderInfo">
	
		SELECT 
		    C.CART_CODE, C.P_NUM, C.M_USERID, C.CART_ACOUNT,
		    P.P_NAME, P.P_COST, P.P_DISCOUNT, P.P_COMPANY, P.P_IMAGE, P.P_IMAGE_DATEFOLDER
		FROM 
		    TBL_CART C INNER JOIN TBL_PRODUCT P 
		ON 
		    C.P_NUM = P.P_NUM
		WHERE 
		    C.M_USERID = #{m_userid}
	
	</select>
	
	<!-- 주문 폼 중 상품 목록 -->
	<select id="directOrderList" resultType="com.docmall.domain.CartOrderInfo">
	
		SELECT 
			P_NUM, P_NAME, P_DISCOUNT, P_COMPANY, P_IMAGE, P_IMAGE_DATEFOLDER, P_COST, #{o_amount} as cart_acount
		FROM 
		    TBL_PRODUCT
		WHERE 
		   P_NUM = #{p_num}
	
	</select>
	
	<!-- <selectKey>
		시퀀스와 관련있는 태그
		- order속성 : 메인쿼리인 아래 INSERT문보다 먼저 실행할지, 나중에 실행할지 선택 가능
		- keyProperty="o_code" : result값을 OrderVO클래스의 o_code 필드에 대입하겠다
			- 메인 insert문에서   SEQ_ORDER_CODE.nextval 대신 #{o_code} 사용
			-->
	<!-- 주문 저장  1)주문 테이블 -->
	<insert id="orderSave">
	
		<selectKey resultType="LONG" order="BEFORE" keyProperty="o_code">
			SELECT SEQ_ORDER_CODE.nextval FROM dual
		</selectKey>
		
		INSERT INTO 
			TBL_ORDER
				(O_CODE, M_USERID, O_NAME, O_POST, O_ADDR, O_ADDR_D, O_TEL, O_TOTALCOST, O_MESSAGE, PAY_STATUS) 
			VALUES
				(#{o_code}, #{m_userid}, #{o_name}, #{o_post}, #{o_addr}, #{o_addr_d}, #{o_tel}, #{o_totalcost}, #{o_message}, #{pay_status})
				
	</insert>
	
	<!-- 주문 저장 2)주문 상세테이블 -->
	<insert id="orderDetailSave">
	
		INSERT INTO
			TBL_ORDER_D(O_CODE, P_NUM, O_AMOUNT, O_COST)
		SELECT 
			#{o_code}, C.P_NUM, C.CART_ACOUNT, C.CART_ACOUNT * P.P_COST
		FROM 
			TBL_CART C INNER JOIN TBL_PRODUCT P
	        ON 
	        	C.P_NUM = P.P_NUM
	        WHERE 
	        	M_USERID = #{m_userid}
	
	</insert>
	
	<!-- 결제정보 저장 -->
	<insert id="paymentSave">
	
		INSERT INTO
			PAYMENT_TBL
				(PAY_CODE, O_CODE, PAY_METHOD, 
				PAY_DATE, PATE_TOT_PRICE, PAY_REST_PRICE
				<if test="pay_user != null and !pay_user.equals('')">
					, PAY_PRICE, PAY_USER, PAY_BANK
				</if>
				)
			VALUES
				(SEQ_PAYMENT_CODE.nextval, #{o_code}, #{pay_method}, 
				sysdate, #{pate_tot_price}, #{pay_rest_price}
				<if test="pay_user != null and !pay_user.equals('')">
					, #{pay_price}, #{pay_user}, #{pay_bank}
				</if>
				)
	
	</insert>


</mapper>